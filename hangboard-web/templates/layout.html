<!DOCTYPE html>
<html>
<head>
	
	<title>Hangboard</title>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">



	<!-- Websocket to backend server -->
	<script>
		var wsExercise = new WebSocket("ws://127.0.0.1:4321/");
		var wsGyroscope = new WebSocket("ws://10.101.40.40:4323/");
		var wsForce = new WebSocket("ws://10.101.40.40:4322/");
		var wsBoard = new WebSocket("ws://10.101.40.40:4324/");

		function sendStartSignal ()
		{
			wsExercise.send ("Start");
		}

		function sendStopSignal ()
		{
			wsExercise.send ("Stop");
		}

		function sendGetBoard ()
		{
			wsExercise.send ("GetBoard");
		}

		function sendStartCalibration ()
		{
			wsGyroscope.send ("StartCalibration");
		}

		function sendStopCalibration ()
		{
			wsGyroscope.send ("StopCalibration");
		}

		function sendListWorkouts ()
		{
			wsExercise.send ("ListWorkouts");
		}
	</script>


	<!--- Load Audio Files -->
	<script>
		var one = new Audio('{{url_for('static', filename='sounds/1.mp3')}}');
		var two = new Audio('{{url_for('static', filename='sounds/2.mp3')}}');
		var three = new Audio('{{url_for('static', filename='sounds/3.mp3')}}');
		var four = new Audio('{{url_for('static', filename='sounds/4.mp3')}}');
		var five = new Audio('{{url_for('static', filename='sounds/5.mp3')}}');
		var six = new Audio('{{url_for('static', filename='sounds/6.mp3')}}');
		var seven = new Audio('{{url_for('static', filename='sounds/7.mp3')}}');
		var eight = new Audio('{{url_for('static', filename='sounds/8.mp3')}}');
		var nine = new Audio('{{url_for('static', filename='sounds/9.mp3')}}');
		var ten = new Audio('{{url_for('static', filename='sounds/10.mp3')}}');
		var done = new Audio('{{url_for('static', filename='sounds/done.mp3')}}');
		var failed = new Audio('{{url_for('static', filename='sounds/failed.mp3')}}');
	</script>

	<!-- Connection to Sensors -->
	<script>
		wsGyroscope.onmessage = function(event) {
			var parsed = JSON.parse(event.data);
			$('.sensor-label').text("X: " + parsed.AngleX + " Y: " + parsed.AngleY 
			+ " NoHang: " + parsed.AngleX_NoHang + " Hang: " + parsed.AngleX_Hang
			+ " HangDetected: " + parsed.HangDetected);
		}
	</script>

	<!-- Create a dynamic list-->
	<script>
		function makeUL(array) {
			var list = document.createElement('ul');

			for (var i = 0; i < array.length; i++) {
				var item = document.createElement('li');
				item.appendChild(document.createTextNode(array[i].ID));
				item.appendChild(document.createTextNode(array[i].Name));
				list.appendChild(item);
			}

			return list;
		}
	</script>


	<!--- Visualize Progress -->
	<script>
		var boardimagename = "";
		var boardname = "";

		wsExercise.onmessage = function(event) {
			var parsed = JSON.parse(event.data);
			console.log (parsed);

			var completed = 0

			if ("TimerStatus" in parsed)
			{
				completed = parsed.Completed;

				boardimagename = parsed.BoardImageName;
				boardname = parsed.BoardName;
				
				$('.progress-bar').css('width', completed+'%').attr('aria-valuenow', completed);
				$('.progress-bar-label').text(completed+'% of ' + parsed.Duration + "(s)");
				var togo = parsed.Duration-parsed.Counter;
				$('.exercise-label').text("Exercise: " + parsed.Exercise + " for " + parsed.Duration + "(s) and still " + togo + "(s) remaining.");

				// Play Sound
				if (parsed.TimerStatus == false) 
				{
					if (togo == 10) { ten.play() ; }		
					if (togo == 9) { nine.play() ; }		
					if (togo == 8) { eight.play() ; }		
					if (togo == 7) { seven.play() ; }		
					if (togo == 6) { six.play() ; }		
					if (togo == 5) { five.play() ; }		
					if (togo == 4) { four.play() ; }		
					if (togo == 3) { three.play() ; }		
					if (togo == 2) { two.play() ; }		
					if (togo == 1) { one.play() ; }		
					if (togo == 0) { done.play() ; }		
				}

				// Highlight holds to be used
				var array = parsed.HoldsActive; 
				array.forEach(element => console.log(element));
				array.forEach(element => window[element].setAttribute("display","inline") );

				var array = parsed.HoldsInactive;
				array.forEach(element => console.log(element));
				array.forEach(element => window[element].setAttribute("display","none") );

			}

			// Update list of workouts
			if ("WorkoutList" in parsed)
			{
				document.getElementById('ListExercises').appendChild(makeUL(parsed.WorkoutList));
				$('.list-label').text("oikok"); //parsed.WorkoutList);
			}
		}
	</script>

	<!--- Load Board Image -->
	<script>
		document.addEventListener("onload",inlineSVG(),false)
		function inlineSVG()
		{
			var SVGFile="{{url_for('static', filename='zlagboard_evo.svg')}}"
			var loadXML = new XMLHttpRequest;
			function handler(){
			if(loadXML.readyState == 4 && loadXML.status == 200)
				svgInlineDiv.innerHTML=loadXML.responseText
			}
			if (loadXML != null){
				loadXML.open("GET", SVGFile, true);
				loadXML.onreadystatechange = handler;
				loadXML.send();
			}
			sendGetBoard();
		}
	</script>

</head>
<body>

	<!--- Navigation Bar -->
	<ul class="nav nav-tabs">
		<li class="nav-item">
		  <a class="nav-link" aria-current="page" href="/">Exercise</a>
		</li>
		<li class="nav-item">
		  <a class="nav-link disabled" href="/selectexercise" tabindex="2">Select Exercise</a>
		</li>
		<li class="nav-item">
			<a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Assessment</a>
		</li>		
		<li class="nav-item">
			<a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Weight Measurement</a>
		</li>
		<li class="nav-item">
		  <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Velocity Measurement</a>
		</li>
		<li class="nav-item">
			<a class="nav-link active" href="/calibration" tabindex="3">Calibration</a>
		</li>		
	</ul>


      {% block content %}{% endblock %}



</body>
</html>
